%% get image
clf;
clc;
close all;
img = imread('images/input/a4.jpg');

dogimg = dog(img);

%% get lines
img_gray = rgb2gray(dogimg);
lines = APPgetLargeConnectedEdges(img_gray, 0.02*sqrt(size(img_gray,1)^2 + size(img_gray,2)^2));
figure(1), hold off, imshow(img)
% figure(1), hold on, plot(lines(:, [1 2])', lines(:, [3 4])','LineWidth',3);

%% group lines
n_line_group = 3;
kmeans_lines = lines(:,[5,6]);
idx = kmeans(kmeans_lines,n_line_group);
figure(2), hold off, imshow(img);

lines1 = lines(idx==1,:);
lines2 = lines(idx==2,:);
lines3 = lines(idx==3,:);

figure(2), hold on, plot(lines1(:, [1 2])', lines1(:, [3 4])','r','LineWidth',3);
figure(2), hold on, plot(lines2(:, [1 2])', lines2(:, [3 4])','g','LineWidth',3);
figure(2), hold on, plot(lines3(:, [1 2])', lines3(:, [3 4])','b','LineWidth',3);


% %% ransac 
fprintf('begin line 1\n');
[pt1, in1, out1] = ransac(lines1);
[in11, out11] = prune(pt1, lines);
kmeans_lines = lines(out11,[5,6]);
idx = kmeans(kmeans_lines,2);
lines2 = lines(idx==1,:);
fprintf('begin line 2\n');

[pt2, in2, out2] = ransac(lines2);
[in22, out22] = prune(pt2, lines(out11,:));
lines3 = lines(out22,:);
fprintf('begin line 3\n');

[pt3, in3, out3] = ransac(lines3);

[length(in1), length(out1)]
[length(in2), length(out2)]
[length(in3), length(out3)]

%% Plot all 3 infinity points
figure(3);
hold on;

imagesc(img);
plot(lines1(in1, [1 2])', lines1(in1, [3 4])','r','LineWidth',1);
plot(lines2(in2, [1 2])', lines2(in2, [3 4])','g','LineWidth',1);
plot(lines3(in3, [1 2])', lines3(in3, [3 4])','b','LineWidth',1);

% plot(lines1(out1, [1 2])', lines1(out1, [3 4])','y','LineWidth',1);
% plot(lines2(out2, [1 2])', lines2(out2, [3 4])','y','LineWidth',1);
plot(lines3(out3, [1 2])', lines3(out3, [3 4])','y','LineWidth',1);
plot(pt1(1),pt1(2),'r.','MarkerSize',30);
plot(pt2(1),pt2(2),'g.','MarkerSize',30);
plot(pt3(1),pt3(2),'b.','MarkerSize',30);

set(gca,'YDir','reverse')

%% Plot individual point
figure(4);
hold on;
imagesc(img);
set(gca,'YDir','reverse')
plot(lines1(in1, [1 2])', lines1(in1, [3 4])','r','LineWidth',1);
plot(lines2(in2, [1 2])', lines2(in2, [3 4])','g','LineWidth',1);
plot(lines3(in3, [1 2])', lines3(in3, [3 4])','b','LineWidth',1);

% plot(lines1(out1, [1 2])', lines1(out1, [3 4])','y','LineWidth',1);
% plot(lines2(out2, [1 2])', lines2(out2, [3 4])','y','LineWidth',1);
plot(lines3(out3, [1 2])', lines3(out3, [3 4])','y','LineWidth',1);
plot(pt2(1),pt2(2),'g.','MarkerSize',30);

figure(5);
hold on;
imagesc(img);
set(gca,'YDir','reverse')
plot(lines1(in11, [1 2])', lines1(in11, [3 4])','r','LineWidth',1);
plot(lines2(in22, [1 2])', lines2(in22, [3 4])','g','LineWidth',1);
plot(lines3(in3, [1 2])', lines3(in3, [3 4])','b','LineWidth',1);

plot(lines1(out1, [1 2])', lines1(out1, [3 4])','y','LineWidth',1);
plot(lines2(out2, [1 2])', lines2(out2, [3 4])','y','LineWidth',1);
plot(lines3(out3, [1 2])', lines3(out3, [3 4])','y','LineWidth',1);
plot(pt1(1),pt1(2),'r.','MarkerSize',30);

figure(6);
hold on;
imagesc(img);
set(gca,'YDir','reverse')
plot(lines1(in1, [1 2])', lines1(in11, [3 4])','r','LineWidth',1);
plot(lines2(in2, [1 2])', lines2(in22, [3 4])','g','LineWidth',1);
plot(lines3(in3, [1 2])', lines3(in3, [3 4])','b','LineWidth',1);

% plot(lines1(out1, [1 2])', lines1(out1, [3 4])','y','LineWidth',1);
% plot(lines2(out2, [1 2])', lines2(out2, [3 4])','y','LineWidth',1);
plot(lines3(out3, [1 2])', lines3(out3, [3 4])','y','LineWidth',1);
plot(pt3(1),pt3(2),'b.','MarkerSize',30);
