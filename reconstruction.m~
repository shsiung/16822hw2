clc;
close all;

%% Read image
I1 = imread('images/input/3_001.jpg');
I2 = imread('images/input/3_002.jpg');
i1 = rgb2gray(I1);
i2 = rgb2gray(I2);
points1 = corner(i1,'MinimumEigenvalue',50000);
points2 = corner(i2,'MinimumEigenvalue',50000);
[features1, valid_points1] = extractFeatures(i1, points1);
[features2, valid_points2] = extractFeatures(i2, points2);
indexPairs = matchFeatures(features1, features2);
matchedPoints1 = valid_points1(indexPairs(:, 1), :);
matchedPoints2 = valid_points2(indexPairs(:, 2), :);
ax = axes;
showMatchedFeatures(I1,I2,matchedPoints1([45],:),matchedPoints2([45],:),'montage','Parent',ax);
%15, 8, 18
%% Finding vanishing points
[VP,g1,g2,g3] = vpt_detection('images/input/3_001.jpg',false);

%17 30 36 45

%% Find subset matched points
iterNum =500;
bestH = 0;
bestIn = [];
bestOut = [];
for p = 1:iterNum
    numInliers = 0;
    inliers = [];
    outliers = [];
    pts = randi(lengh(matchedPoints1),4,1);

    pts1 = matchedPoints1(pts,:);
    pts2 = matchedPoints2(pts,:);
    H = dlt_homography( pts1,pts2,size(I1,2),size(I1,1))';
%   [rectI] = applyH(I1, H);
    
    inliers1 = [];
    inliers2 = [];
    for i = 1:length(matchedPoints1)
        match_pt = H*[matchedPoints1(i,:) 1]';
        match_pt = match_pt/match_pt(3);
        pt = matchedPoints2(i,:);
        if (sqrt((match_pt(1)-pt(1))^2 + (match_pt(2)-pt(2))^2) < 20)
            inliers1 = [inliers1; 
                             matchedPoints1(i,:)];
            inliers2 = [inliers2; 
                             matchedPoints2(i,:)];
            numInliers = numInliers + 1;
        end
    end

    if (numInliers > bestH)
        bestH = H;
        best1 = inliers1;
        best2 = inliers2;
    end
end
% pt1 = [ matchedPoints1(1,:) ;
%         matchedPoints1(2,:) ;
%         matchedPoints1(3,:) ;
%         matchedPoints1(4,:) ];
% pt2 = [ matchedPoints2(1,:) ;
%         matchedPoints2(2,:) ;
%         matchedPoints2(3,:);
%         matchedPoints2(4,:) ];
% % 
% pt1 = [ matchedPoints1(17,:) ;
%         matchedPoints1(30,:) ;
%         matchedPoints1(36,:) ;
%         matchedPoints1(45,:) ];
% pt2 = [ matchedPoints2(17,:) ;
%         matchedPoints2(30,:) ;
%         matchedPoints2(36,:);
%         matchedPoints2(45,:) ];


%% Fine homography
% H = dlt_homography( pt1,pt2,size(I1,2),size(I1,1))';
[rectI] = applyH(I1, H);

testp1 = matchedPoints1(12,:);
testp2 = matchedPoints2(12,:);

figure(2);
subplot(2,2,1);
imshow(rectI);
subplot(2,2,2);
C = imfuse(I2,rectI,'blend','Scaling','joint');
imshow(C);
t = mean(pt2-pt1,1);
tI2 = imtranslate(I2,[-t(1) t(2)]);
J = imfuse(tI2,rectI,'blend','Scaling','joint');
subplot(2,2,3);
imshow(J);

%% Calculate inliers
inliers1 = [];
inliers2 = [];
for i = 1:length(matchedPoints1)
    match_pt = H*[matchedPoints1(i,:) 1]';
    match_pt = match_pt/match_pt(3);
    pt = matchedPoints2(i,:);
    if (sqrt((match_pt(1)-pt(1))^2 + (match_pt(2)-pt(2))^2) < 20)
        inliers1 = [inliers1; 
                         matchedPoints1(i,:)];
        inliers2 = [inliers2; 
                         matchedPoints2(i,:)];
    end
end

figure(3)
ax = axes;
showMatchedFeatures(I1,I2,inliers1,inliers2,'montage','Parent',ax);

%% Convex hull
K = convhull(inliers1(:,1),inliers1(:,2));
hold on;
plot(inliers1(K,1),inliers1(K,2),'r-',inliers1(:,1),inliers1(:,2),'b*','LineWidth',2);
    plot(g1(:,[1 2])', g1(:,[3 4])','r','LineWidth',1);
    plot(g2(:,[1 2])', g2(:,[3 4])','g','LineWidth',1);
    plot(g3(:,[1 2])', g3(:,[3 4])','b','LineWidth',1);

